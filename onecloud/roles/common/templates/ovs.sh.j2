#!/bin/bash

IMG={{ insecure_registry | default('registry.cn-beijing.aliyuncs.com') }}/{{ registry | default('yunionio') }}/openvswitch:2.12.4-20251218

{% if k8s_or_k3s | default('k3s') == 'k3s' %}
k3s ctr images list name==$IMG -q | grep $IMG > /dev/null
if [ $? -ne 0 ]; then
    k3s ctr images pull $IMG
fi

k3s ctr run --rm --net-host -t \
    --mount type=bind,src=/tmp,dst=/tmp,options=rbind \
    --mount type=bind,src=/etc/openvswitch,dst=/etc/openvswitch,options=rbind \
    --mount type=bind,src=/var/run/openvswitch,dst=/var/run/openvswitch,options=rbind \
    $IMG \
    openvswitch \
    /usr/bin/$(basename $0) $@
{% else %}
docker run --rm --network host \
    -v /tmp:/tmp \
    -v /etc/openvswitch:/etc/openvswitch \
    -v /var/run/openvswitch:/var/run/openvswitch \
    $IMG \
    /usr/bin/$(basename $0) $@
{% endif %}

