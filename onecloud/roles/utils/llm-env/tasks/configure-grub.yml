- name: Check if nvidia-drm.modeset=1 is already in GRUB_CMDLINE_LINUX
  shell: grep -q "nvidia-drm.modeset=1" /etc/default/grub
  register: grub_check
  ignore_errors: true
  failed_when: false

- name: Add nvidia-drm.modeset=1 to GRUB_CMDLINE_LINUX
  replace:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX="[^"]*)"'
    replace: '\1 nvidia-drm.modeset=1"'
  become: true
  when: grub_check.rc != 0

- name: Update GRUB configuration
  shell: grub2-mkconfig > /boot/efi/EFI/openEuler/grub.cfg
  become: true
  args:
    executable: /bin/bash
  when: grub_check.rc != 0
  register: grub_update_result

- name: Reboot system after grub update
  reboot:
    msg: "Reboot initiated by Ansible after adding nvidia-drm.modeset=1 and updating grub"
    connect_timeout: 5
    reboot_timeout: 600
    pre_reboot_delay: 0
    post_reboot_delay: 30
    test_command: whoami
  become: true
  when: grub_check.rc != 0
